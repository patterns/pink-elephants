spin_version = "1"
authors = ["patterns <addq1eax@gmail.com>"]
description = "Pink Elephants on Parade"
name = "cloud_start"
trigger = { type = "http", base = "/" }
version = "0.6.7"

[variables]
self_actor = { default = "echo" }
site_name = { required = true }
domain_base = { required = true }
redis_server = { required = true }
redis_login = { required = true, secret = true }
verifier_proxy = { required = true }
verifier_bearer = { required = true, secret = true }
httpsig_origin = { default = "" }
httpsig_gateway = { default = "" }

[[component]]
id = "bartholomew"
files = [ "content/**/*" , "templates/*", "scripts/*", "config/*", "shortcodes/*", "themes/bromide/templates/*", "themes/bromide/scripts/*" ]
[component.source]
url = "https://github.com/fermyon/bartholomew/releases/download/v0.8.0/bartholomew.wasm"
digest = "sha256:ad5ac6215fb67ca122011d2d12840cb69ba80819499641349e92c05ceb65afc1"
[component.trigger]
route = "/..."

[[component]]
id = "fileserver"
files = [{ source = "themes/bromide/static", destination = "/" }, { source = "static/", destination = "/" } ]
[component.source]
url = "https://github.com/fermyon/spin-fileserver/releases/download/v0.0.3/spin_static_fs.wasm"
digest = "sha256:38bf971900228222f7f6b2ccee5051f399adca58d71692cdfdea98997965fd0d"
[component.trigger]
route = "/static/..."

[[component]]
id = "inbox"
source = "modules/inbox.wasm"
allowed_http_hosts = ["verifier-key-rcv.pages.dev"]
[component.trigger]
route = "/inbox"
[component.config]
redis_address = "redis://{{ redis_login }}@{{ redis_server }}"
verifier_proxy_uri = "https://{{ verifier_proxy }}/api/verifiers"
verifier_proxy_bearer = "{{ verifier_bearer }}"
httpsig_host_origin = "{{ httpsig_origin }}"
httpsig_host_gateway = "{{ httpsig_gateway }}"

[[component]]
id = "outbox"
source = "modules/outbox.wasm"
allowed_http_hosts = ["verifier-key-rcv.pages.dev"]
[component.trigger]
route = "/outbox"
[component.config]
redis_address = "redis://{{ redis_login }}@{{ redis_server }}"
verifier_proxy_uri = "https://{{ verifier_proxy }}/api/verifiers"
verifier_proxy_bearer = "{{ verifier_bearer }}"
httpsig_host_origin = "{{ httpsig_origin }}"
httpsig_host_gateway = "{{ httpsig_gateway }}"

[[component]]
id = "webfinger"
source = "modules/webfinger.wasm"
[component.trigger]
route = "/well-known/webfinger"
[component.config]
site_name = "{{ site_name }}"
site_subdomain = "{{ site_name }}.{{ domain_base }}"
self_actor = "{{ self_actor }}"
[[component]]
id = "dotwebfinger"
source = "modules/webfinger.wasm"
[component.trigger]
route = "/.well-known/webfinger"
[component.config]
site_name = "{{ site_name }}"
site_subdomain = "{{ site_name }}.{{ domain_base }}"
self_actor = "{{ self_actor }}"

[[component]]
id = "actor"
source = "modules/actor.wasm"
[component.trigger]
route = "/u/..."
[component.config]
site_subdomain = "{{ site_name }}.{{ domain_base }}"
self_actor = "{{ self_actor }}"

